<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Яндекс Лавка - Корзина</title>
    <style>
        /* Custom Fonts */
        @font-face {
            font-family: 'YS Text';
            src: url('./assets/fonts/YS Text-Light.ttf') format('truetype');
            font-weight: 300;
            font-style: normal;
        }
        @font-face {
            font-family: 'YS Text';
            src: url('./assets/fonts/YS Text-Regular.ttf') format('truetype');
            font-weight: 400;
            font-style: normal;
        }
        @font-face {
            font-family: 'YS Text';
            src: url('./assets/fonts/YS Text-Medium.ttf') format('truetype');
            font-weight: 500;
            font-style: normal;
        }
        @font-face {
            font-family: 'YS Text';
            src: url('./assets/fonts/YS Text-Bold.ttf') format('truetype');
            font-weight: 700;
            font-style: normal;
        }
        @font-face {
            font-family: 'YS Text';
            src: url('./assets/fonts/YS Text-Black.ttf') format('truetype');
            font-weight: 900;
            font-style: normal;
        }

        /* Design System - Variables */
        :root {
            /* Colors */
            --color-primary: #FCE000;
            --color-primary-dark: #E8CD00;
            --color-green: #00B341;
            --color-red: #FF3333;
            --color-orange: #EF6C00;
            --color-pay-green: #006933;
            --color-text-primary: #000000;
            --color-text-secondary: #666666;
            --color-text-tertiary: #999999;
            --color-bg-primary: #FFFFFF;
            --color-bg-secondary: #F5F5F5;
            --color-bg-card: #F8F8F8;
            --color-border: #E8E8E8;
            --color-badge-blue: #00AAFF;
            --color-image-bg: #F8F7F5;
            --color-qty-bg: #5C5A571A;
            --color-badge-blue-light: #CDEEFE;
            --color-badge-blue-dark: #29A5F7;
            --color-icon-inactive: #999999;
            --color-icon-active: #000000;
            
            /* Typography */
            --font-family: 'YS Text', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            --font-size-xs: 11px;
            --font-size-sm: 13px;
            --font-size-base: 15px;
            --font-size-md: 17px;
            --font-size-lg: 20px;
            --font-size-xl: 24px;
            
            /* Spacing */
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 12px;
            --spacing-lg: 16px;
            --spacing-xl: 20px;
            --spacing-2xl: 24px;
            
            /* Border Radius */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
            --radius-full: 9999px;
        }

        /* Reset & Base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: var(--font-family);
            font-size: var(--font-size-base);
            color: var(--color-text-primary);
            background: var(--color-bg-secondary);
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            touch-action: manipulation;
        }

        button {
            font-family: inherit;
        }

        /* Status Bar */
        .status-bar {
            background: var(--color-bg-primary);
            padding: 0 var(--spacing-xl);
            height: 44px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: var(--font-size-base);
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .status-icons {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .status-icons img {
            height: 12px;
        }

        /* Header */
        .header {
            background: var(--color-bg-primary);
            padding: var(--spacing-md) var(--spacing-lg);
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            border-bottom: 1px solid var(--color-border);
            position: sticky;
            top: 44px; /* Height of the status bar */
            z-index: 100;
        }

        .header-title {
            font-size: var(--font-size-md);
            font-weight: 600;
            grid-column: 2;
        }

        .header-actions {
            display: flex;
            gap: var(--spacing-lg);
            grid-column: 3;
            justify-self: end;
        }

        .icon-btn {
            background: none;
            border: none;
            padding: var(--spacing-xs);
            cursor: pointer;
        }

        .icon-btn img {
            width: 24px;
            height: 24px;
            display: block;
        }

        /* Tabs */
        .tabs {
            padding: var(--spacing-sm) var(--spacing-lg);
            display: flex;
            gap: var(--spacing-md);
        }

        .tab {
            flex: 1;
            padding: var(--spacing-md);
            border-radius: var(--radius-xl);
            border: 1.5px solid var(--color-border);
            background: var(--color-bg-primary);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab.active {
            border-color: var(--color-primary);
            border-width: 2px;
            background: transparent;
        }

        .tab-icon {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-md);
            background: var(--color-bg-card);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            overflow: hidden;
        }

        .tab-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .tab-content {
            flex: 1;
        }

        .tab-title {
            font-size: var(--font-size-sm);
            font-weight: 500;
            color: var(--color-text-primary);
        }

        .tab-subtitle {
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
        }

        /* Delivery Info */
        .delivery-info {
            background: var(--color-bg-card);
            padding: var(--spacing-md) var(--spacing-md) 22px;
            border-radius: var(--radius-lg);
            margin: 0 var(--spacing-lg) 8px;
        }

        .delivery-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--spacing-md);
        }

        .delivery-main {
            font-size: var(--font-size-base);
            font-weight: 500;
            color: var(--color-pay-green);
        }

        .delivery-fee-value {
            font-weight: 700;
        }

        #delivery-original-cost {
            color: var(--color-text-tertiary);
        }

        .delivery-hint {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
            margin-top: var(--spacing-xs);
        }

        .badge-green {
            background: var(--color-pay-green);
            color: white;
            padding: 2px 6px;
            border-radius: var(--radius-full);
            font-size: var(--font-size-xs);
            font-weight: 600;
            margin: 0 var(--spacing-xs);
        }

        .progress-bar-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: var(--spacing-2xl); /* Increased padding */
            scrollbar-width: auto; /* For Firefox */
        }

        /* Hide scrollbar on touch devices for a cleaner look */
        @media (hover: none) and (pointer: coarse) {
            .progress-bar-container {
                scrollbar-width: none; /* For Firefox */
            }
            .progress-bar-container::-webkit-scrollbar {
                display: none;
            }
        }

        .progress-bar-scroll {
            display: flex;
            align-items: center;
            min-width: 450px; /* Make it wider to be scrollable */
        }

        .progress-bar-track {
            flex-grow: 1;
            height: 12px;
            background-color: var(--color-border);
            border-radius: var(--radius-full);
            position: relative;
            display: flex;
        }

        .progress-bar-fill {
            height: 100%;
            background: var(--color-pay-green);
            border-radius: var(--radius-full);
            transition: width 0.3s ease-in-out;
        }

        .progress-segment {
            height: 100%;
            border-radius: var(--radius-full);
        }

        .milestone {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .milestone-label-top {
            position: absolute;
            bottom: calc(100% + 8px);
            white-space: nowrap;
            font-size: var(--font-size-sm);
            font-weight: 500;
            background-color: var(--color-bg-card);
            padding: 2px 6px;
            border-radius: var(--radius-sm);
            color: var(--color-text-primary);
            left: 50%;
            transform: translateX(-50%);
        }
        
        .milestone-label {
             position: absolute;
             top: 50%;
             left: 50%;
             transform: translateX(-50%);
             margin-top: 10px;
             font-size: var(--font-size-sm);
             font-weight: 500;
             color: var(--color-text-tertiary);
             white-space: nowrap;
        }
        
        .milestone::after {
            content: '';
            position: absolute;
            height: 16px;
            width: 4px;
            background: var(--color-bg-card);
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .milestone.milestone-first {
            transform: translate(0, -50%);
        }

        .milestone.milestone-last {
            transform: translate(-100%, -50%);
        }

        .milestone.milestone-first::after,
        .milestone.milestone-last::after {
            display: none;
        }

        .milestone-first .milestone-label {
            left: 0;
            transform: translateX(0);
        }

        .milestone-last .milestone-label {
            left: 100%;
            transform: translateX(-100%);
        }

        .milestone.complete .milestone-label {
            color: var(--color-pay-green);
        }

        .milestone.discount .milestone-label {
            color: var(--color-orange);
            font-weight: 700;
        }
        
        .discount-icon {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background-color: var(--color-orange);
            color: white;
            font-size: 10px;
            font-weight: 700;
            margin-right: 4px;
            vertical-align: middle;
        }

        /* Cart Items */
        .cart-items {
            padding: var(--spacing-sm) var(--spacing-lg);
        }

        .visual-container {
            background: var(--color-bg-primary);
            border-radius: var(--radius-lg);
            margin: 0 0 8px;
            overflow: hidden;
        }

        .visual-container > div:not(:first-child) {
            border-top: 1px solid var(--color-border);
        }

        .visual-container > .delivery-info {
            border-top: none;
        }

        .cart-item {
            display: flex;
            gap: var(--spacing-md);
            padding: var(--spacing-md) 0;
            align-items: center;
        }

        .item-image {
            width: 64px;
            height: 64px;
            border-radius: var(--radius-lg);
            background: var(--color-image-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-sm);
        }

        .item-details {
            flex: 1;
        }

        .item-name {
            font-size: var(--font-size-base);
            font-weight: 500;
            margin-bottom: var(--spacing-xs);
        }

        .item-price {
            display: flex;
            align-items: baseline;
            gap: var(--spacing-sm);
        }

        .price-current {
            font-size: var(--font-size-base);
            font-weight: 600;
            color: var(--color-text-primary);
        }

        .price-current.has-discount {
            color: var(--color-red);
        }

        .price-old {
            font-size: var(--font-size-sm);
            color: var(--color-text-tertiary);
            position: relative;
        }

        .price-old::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 1px;
            background-color: var(--color-red);
            top: 50%;
            left: 0;
            transform: translateY(-50%);
        }

        .price-weight {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            background: var(--color-qty-bg);
            border-radius: var(--radius-lg);
            padding: 0 var(--spacing-xs);
            height: 36px;
        }

        .quantity-controls .qty-btn {
            width: 36px;
            height: 100%;
            border-radius: var(--radius-full);
            border: none;
            background: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-size-base);
            cursor: pointer;
            transition: all 0.2s;
        }

        .qty-btn:active {
            transform: scale(0.95);
            background-color: rgba(0,0,0,0.05);
        }

        .qty-value {
            font-size: var(--font-size-sm);
            font-weight: 600;
            min-width: 20px;
            text-align: center;
            line-height: 1;
        }

        /* Order Summary */
        .order-summary {
            padding: var(--spacing-lg);
            border-top: none;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-sm) 0;
        }

        .summary-label {
            font-size: var(--font-size-base);
            color: var(--color-text-primary);
        }

        .summary-value {
            font-size: var(--font-size-md);
            font-weight: 600;
        }

        /* Package Return */
        .package-return {
            padding: var(--spacing-md);
            border-top: none;
        }

        .return-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .return-text {
            flex: 1;
        }

        .return-title {
            font-size: var(--font-size-base);
            margin-bottom: var(--spacing-xs);
        }

        .return-link {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
        }

        .toggle-switch {
            width: 51px;
            height: 31px;
            background: var(--color-border);
            border-radius: var(--radius-full);
            position: relative;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch.active {
            background: var(--color-primary);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 27px;
            height: 27px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.3s;
        }

        .toggle-switch.active::after {
            transform: translateX(20px);
        }

        /* Promo Banner */
        .promo-banner {
            background: var(--color-bg-card);
            padding: var(--spacing-md);
            border-radius: var(--radius-lg);
            margin-bottom: var(--spacing-md);
        }

        .promo-card {
            background: transparent;
            color: var(--color-text-primary);
            padding: 0;
            border-radius: 0;
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .promo-icon {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--color-badge-blue-light);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-shrink: 0;
        }

        .promo-icon-ticket {
            position: relative;
            background: var(--color-badge-blue-dark);
            color: white;
            font-weight: 1000;
            font-size: var(--font-size-sm);
            padding: 6px 14px;
            border-radius: 6px;
            transform: rotate(-10deg);
        }

        .promo-icon-ticket::before,
        .promo-icon-ticket::after {
            content: '';
            position: absolute;
            width: 8px;
            height: 8px;
            background: var(--color-bg-card);
            border-radius: 50%;
            top: 50%;
            transform: translateY(-50%);
        }

        .promo-icon-ticket::before {
            left: -4px;
        }

        .promo-icon-ticket::after {
            right: -4px;
        }

        .promo-text {
            flex: 1;
            font-size: var(--font-size-sm);
            font-weight: 500;
            line-height: 1.4;
        }

        /* Recommendations */
        .recommendations {
            padding: var(--spacing-md);
            border-top: none;
        }

        .recommendations-header {
            font-size: var(--font-size-lg);
            font-weight: 700;
            margin-bottom: var(--spacing-md);
        }

        .recommendations-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--spacing-md);
        }

        .recommendation-card {
            background: var(--color-bg-primary);
            border-radius: var(--radius-lg);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            border: none;
        }

        .rec-image-container {
            position: relative;
            width: 100%;
            padding-top: 100%; /* 1:1 Aspect Ratio */
            background-color: var(--color-image-bg);
        }

        .rec-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            padding: var(--spacing-sm);
        }

        .rec-discount-badge {
            position: absolute;
            bottom: var(--spacing-sm);
            left: var(--spacing-sm);
            background-color: var(--color-red);
            color: white;
            padding: 2px 8px;
            border-radius: var(--radius-sm);
            font-size: var(--font-size-sm);
            font-weight: 600;
            transform: rotate(-10deg);
        }
        
        .rec-add-btn {
            position: absolute;
            bottom: var(--spacing-sm);
            right: var(--spacing-sm);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: var(--color-bg-primary);
            border: none;
            font-size: 24px;
            font-weight: 300;
            color: var(--color-text-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: transform 0.1s ease-in-out;
        }
        .rec-add-btn:active {
            transform: scale(0.92);
        }
        
        .rec-quantity-controls {
            position: absolute;
            bottom: var(--spacing-sm);
            right: var(--spacing-sm);
            display: flex;
            align-items: center;
            background: var(--color-bg-primary);
            border-radius: var(--radius-full);
            height: 36px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .rec-quantity-controls .qty-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            line-height: 1;
            font-weight: 400;
            cursor: pointer;
            color: var(--color-text-primary);
            transition: background-color 0.15s ease;
        }

        .rec-quantity-controls .qty-btn:active {
            background-color: var(--color-bg-secondary);
        }

        .rec-quantity-controls .qty-value {
            font-size: var(--font-size-base);
            font-weight: 600;
            min-width: 24px;
            text-align: center;
        }

        .rec-details {
            padding: var(--spacing-sm) var(--spacing-md) var(--spacing-md);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
            flex-grow: 1;
        }
        
        .rec-price {
            display: flex;
            align-items: baseline;
            gap: var(--spacing-sm);
            margin-bottom: 2px;
        }
        
        .rec-price .price-current {
            font-size: var(--font-size-md);
            font-weight: 700;
        }

        .rec-name {
            font-size: var(--font-size-sm);
            font-weight: 500;
            line-height: 1.3;
            flex-grow: 1;
        
            /* 3-line clamp */
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
        }

        .rec-name .rec-item-weight {
            color: var(--color-text-tertiary);
        }
        
        .rec-weight {
            font-size: var(--font-size-xs);
            color: var(--color-text-tertiary);
        }

        /* Checkout Footer */
        .checkout-footer {
            position: fixed;
            bottom: 60px;
            left: 0;
            right: 0;
            background: var(--color-bg-primary);
            padding: var(--spacing-lg);
            border-top: 1px solid var(--color-border);
        }

        .checkout-btn {
            background: var(--color-primary);
            color: var(--color-text-primary);
            border: none;
            border-radius: var(--radius-md);
            padding: var(--spacing-lg);
            width: 100%;
            font-size: var(--font-size-md);
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background 0.2s;
        }

        .checkout-btn:active {
            background: var(--color-primary-dark);
        }

        .promo-code-entry {
            display: flex;
            align-items: center;
            margin-bottom: var(--spacing-sm);
            cursor: pointer;
            padding: 0;
        }

        .promo-code-icon {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--color-badge-blue-dark);
            color: white;
            font-weight: 700;
            border-radius: 8px;
            width: 32px;
            height: 24px;
            font-size: 16px;
            margin-right: var(--spacing-md);
            line-height: 1;
            transform: rotate(-10deg);
        }

        .promo-code-icon::before,
        .promo-code-icon::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 8px;
            height: 8px;
            background: var(--color-bg-primary);
            border-radius: 50%;
            transform: translateY(-50%);
        }
        
        .promo-code-icon::before {
            left: -4px;
        }
        
        .promo-code-icon::after {
            right: -4px;
        }

        .promo-code-text {
            flex-grow: 1;
            font-weight: 500;
            font-size: var(--font-size-base);
        }

        .promo-code-arrow {
            font-size: 20px;
            color: var(--color-text-tertiary);
            font-weight: bold;
        }

        .checkout-time {
            font-size: var(--font-size-base);
        }

        .checkout-price {
            display: flex;
            align-items: baseline;
            gap: var(--spacing-sm);
        }

        .price-final {
            font-size: var(--font-size-lg);
        }

        .price-original {
            font-size: var(--font-size-base);
            text-decoration: line-through;
            opacity: 0.7;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--color-bg-primary);
            border-top: 1px solid var(--color-border);
            display: flex;
            justify-content: space-around;
            padding: var(--spacing-sm) 0;
            height: 60px;
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-xs);
            cursor: pointer;
            color: var(--color-icon-inactive);
            position: relative;
        }

        .nav-item.active {
            color: var(--color-icon-active);
        }

        .nav-icon {
            font-size: 20px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-icon img, .nav-icon svg {
            display: block;
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .nav-badge {
            position: absolute;
            top: calc(50% - 10px);
            left: calc(50% + 10px);
            transform: translate(-50%, -50%);
            background: var(--color-red);
            color: white;
            border-radius: var(--radius-full);
            padding: 2px 6px;
            font-size: 10px;
            font-weight: 600;
        }

        /* Spacer for fixed elements */
        .content-spacer {
            height: 140px;
        }

        /* Mobile-specific adjustments */
        @media (max-width: 767px) {
            .status-bar {
                display: none;
            }
            .header {
                top: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Status Bar -->
    <div class="status-bar">
        <div class="time">14:26</div>
        <div class="status-icons">
            <img src="./assets/MobileSignal.svg" alt="Mobile Signal">
            <img src="./assets/WiFi.svg" alt="WiFi">
            <img src="./assets/Battery.svg" alt="Battery">
        </div>
    </div>

    <!-- Header -->
    <header class="header">
        <h1 class="header-title">Корзина</h1>
        <div class="header-actions">
            <button class="icon-btn"><img src="./assets/share_export.svg" alt="Share"></button>
            <button class="icon-btn"><img src="./assets/search_export.svg" alt="Search"></button>
            <button class="icon-btn"><img src="./assets/empty_export.svg" alt="Empty cart"></button>
        </div>
    </header>

    <div class="visual-container">
        <!-- Tabs -->
        <div class="tabs">
            <div class="tab active" data-store="home">
                <div class="tab-icon"></div>
                <div class="tab-content">
                    <div class="tab-title">лавка у дома</div>
                    <div class="tab-subtitle">510₽</div>
                </div>
            </div>
            <div class="tab" data-store="big">
                <div class="tab-icon"></div>
                <div class="tab-content">
                    <div class="tab-title">большая лавка</div>
                    <div class="tab-subtitle">252₽</div>
                </div>
            </div>
        </div>

        <!-- Delivery Info -->
        <div class="delivery-info">
            <div class="delivery-header">
                <div class="delivery-text">
                    <div class="delivery-main">
                        С картой <img src="assets/Я.svg" alt="Яндекс Пэй" style="height: 1em; vertical-align: middle; margin-right: 2px;"> <span style="color: var(--color-pay-green);">Пэй</span><br>
                        <span id="delivery-cost">Доставка <strong class="delivery-fee-value">95₽</strong></span>
                        <span id="delivery-discount" class="badge-green">-20%</span>
                        <span id="delivery-original-cost">/ без: 119₽</span>
                    </div>
                    <div class="delivery-hint" id="delivery-hint">
                        Ещё 801₽, и будет 63₽
                    </div>
                </div>
                <button class="icon-btn">›</button>
            </div>
            <div class="progress-bar-container">
                <div class="progress-bar-scroll">
                    <div class="progress-bar-track">
                        <div class="progress-bar-fill"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cart Items -->
    <div class="cart-items visual-container">
    </div>

    <div class="visual-container">
        <!-- Package Return -->
        <div class="package-return">
            <div class="return-option">
                <div class="return-text">
                    <div class="return-title">Отдать пакеты и получить 12<img src="./assets/Plus.svg" alt="Plus points" style="height: 1em; vertical-align: middle; margin-left: 2px;"></div>
                    <div class="return-link">Какие условия ›</div>
                </div>
                <div class="toggle-switch" id="packageToggle" onclick="toggleSwitch(this)"></div>
            </div>
        </div>
        <!-- Order Summary -->
        <div class="order-summary">
            <div class="summary-row">
                <span class="summary-label">Упаковка заказа ›</span>
                <span class="summary-value">12₽</span>
            </div>
        </div>
    </div>

    <div class="visual-container">
        <!-- Recommendations -->
        <div class="recommendations">
            <!-- Promo Banner -->
            <div class="promo-banner">
                <div class="promo-card">
                    <div class="promo-icon">
                        <div class="promo-icon-ticket" id="promo-badge-text">10%</div>
                    </div>
                    <span class="promo-text" id="promo-main-text">Получите скидку на 10% за 3 заказа<br>с товарами из подборки ›</span>
                </div>
            </div>

            <h2 class="recommendations-header">Подобрали для вас</h2>
            <div class="recommendations-grid">
                <div class="recommendation-card" style="position: relative;">
                    <span class="rec-badge">⚡ ×2</span>
                    <div class="rec-image">🍫</div>
                </div>
                <div class="recommendation-card">
                    <div class="rec-image">🥤</div>
                </div>
                <div class="recommendation-card">
                    <div class="rec-image">🍪</div>
                </div>
            </div>
            
        </div>
    </div>

    <!-- Spacer for fixed footer -->
    <div class="content-spacer"></div>

    <!-- Checkout Footer -->
    <div class="checkout-footer">
        <div class="promo-code-entry">
            <div class="promo-code-icon">%</div>
            <div class="promo-code-text">У вас 2 промокода</div>
            <div class="promo-code-arrow">&rsaquo;</div>
        </div>
        <button class="checkout-btn">
            <span class="checkout-time">15-30 мин</span>
            <span style="flex: 1; text-align: center;">К оплате</span>
            <span class="checkout-price">
                <span class="price-final">510₽</span>
                <span class="price-original">588₽</span>
            </span>
        </button>
    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <div class="nav-item">
            <span class="nav-icon"><svg width="25" height="25" viewBox="0 0 25 25" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12.9 1.49976C18.9751 1.49976 23.9 6.42462 23.9 12.4998C23.9 18.5749 18.9751 23.4998 12.9 23.4998C6.82487 23.4998 1.9 18.5749 1.9 12.4998C1.9 6.42462 6.82487 1.49976 12.9 1.49976ZM16.9586 7.09937C14.9307 6.94214 14.2694 7.79138 13.3404 12.6873C13.3364 12.668 13.0431 11.303 11.0133 8.99585C8.96901 6.67225 7.88457 7.15913 6.94102 8.17065C5.78865 9.40515 6.24826 11.668 7.12363 13.738C7.67991 15.0548 9.14971 17.442 11.0133 18.5476C13.5834 20.0709 17.1211 19.2239 18.7242 14.4568C20.3884 9.51131 18.5442 7.22232 16.9586 7.09937Z" fill="currentColor"/></svg></span>
        </div>
        <div class="nav-item">
            <span class="nav-icon"><svg width="25" height="25" viewBox="0 0 25 25" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M13.6022 5.99063C13.5 6.37213 13.5 6.83712 13.5 7.76709C13.5 8.69706 13.5 9.16205 13.6022 9.54355C13.8796 10.5788 14.6883 11.3875 15.7235 11.6649C16.105 11.7671 16.57 11.7671 17.5 11.7671C18.43 11.7671 18.895 11.7671 19.2765 11.6649C20.3117 11.3875 21.1204 10.5788 21.3978 9.54355C21.5 9.16205 21.5 8.69706 21.5 7.76709C21.5 6.83712 21.5 6.37213 21.3978 5.99063C21.1204 4.95536 20.3117 4.14671 19.2765 3.86931C18.895 3.76709 18.43 3.76709 17.5 3.76709C16.57 3.76709 16.105 3.76709 15.7235 3.86931C14.6883 4.14671 13.8796 4.95536 13.6022 5.99063ZM13.6022 15.9906C13.5 16.3721 13.5 16.8371 13.5 17.7671C13.5 18.6971 13.5 19.162 13.6022 19.5435C13.8796 20.5788 14.6883 21.3875 15.7235 21.6649C16.105 21.7671 16.57 21.7671 17.5 21.7671C18.43 21.7671 18.895 21.7671 19.2765 21.6649C20.3117 21.3875 21.1204 20.5788 21.3978 19.5435C21.5 19.162 21.5 18.6971 21.5 17.7671C21.5 16.8371 21.5 16.3721 21.3978 15.9906C21.1204 14.9554 20.3117 14.1467 19.2765 13.8693C18.895 13.7671 18.43 13.7671 17.5 13.7671C16.57 13.7671 16.105 13.7671 15.7235 13.8693C14.6883 14.1467 13.8796 14.9554 13.6022 15.9906ZM3.5 17.7671C3.5 16.8371 3.5 16.3721 3.60222 15.9906C3.87962 14.9554 4.68827 14.1467 5.72354 13.8693C6.10504 13.7671 6.57003 13.7671 7.5 13.7671C8.42997 13.7671 8.89496 13.7671 9.27646 13.8693C10.3117 14.1467 11.1204 14.9554 11.3978 15.9906C11.5 16.3721 11.5 16.8371 11.5 17.7671C11.5 18.6971 11.5 19.162 11.3978 19.5435C11.1204 20.5788 10.3117 21.3875 9.27646 21.6649C8.89496 21.7671 8.42997 21.7671 7.5 21.7671C6.57003 21.7671 6.10504 21.7671 5.72354 21.6649C4.68827 21.3875 3.87962 20.5788 3.60222 19.5435C3.5 19.162 3.5 18.6971 3.5 17.7671ZM3.60222 5.99063C3.5 6.37213 3.5 6.83712 3.5 7.76709C3.5 8.69706 3.5 9.16205 3.60222 9.54355C3.87962 10.5788 4.68827 11.3875 5.72354 11.6649C6.10504 11.7671 6.57003 11.7671 7.5 11.7671C8.42997 11.7671 8.89496 11.7671 9.27646 11.6649C10.3117 11.3875 11.1204 10.5788 11.3978 9.54355C11.5 9.16205 11.5 8.69706 11.5 7.76709C11.5 6.83712 11.5 6.37213 11.3978 5.99063C11.1204 4.95536 10.3117 4.14671 9.27646 3.86931C8.89496 3.76709 8.42997 3.76709 7.5 3.76709C6.57003 3.76709 6.10504 3.76709 5.72354 3.86931C4.68827 4.14671 3.87962 4.95536 3.60222 5.99063Z" fill="currentColor"/></svg></span>
        </div>
        <div class="nav-item">
            <span class="nav-icon"><svg width="25" height="25" viewBox="0 0 25 25" fill="none" xmlns="http://www.w3.org/2000/svg"><g clip-path="url(#clip0_1005_11986)"><path d="M15.5 21.2672C15.4998 23.2001 12.3658 24.7672 8.5 24.7672C4.63415 24.7672 1.50024 23.2001 1.5 21.2672V19.7672C1.50042 20.8716 4.63427 21.7672 8.5 21.7672C12.3657 21.7672 15.4996 20.8716 15.5 19.7672V21.2672ZM14.8848 1.97908C15.1274 1.78966 15.4435 1.72285 15.7422 1.79744L19.7422 2.79744L19.2578 4.73689L16.5 4.04842V5.78279C20.4656 5.89084 23.4995 6.64037 23.5 7.76717V9.76717L22.5 10.7672L20.7256 20.0826C20.5754 20.8711 20.4879 21.7539 19.8613 22.2554C19.372 22.6469 18.508 23.0386 16.9834 23.1949C17.3001 22.6357 17.4999 21.9957 17.5 21.2672V17.6236C17.4998 16.5892 17.0245 15.709 16.5068 15.067C15.9717 14.4034 15.2617 13.8269 14.4756 13.357C12.9448 12.4422 10.9132 11.8048 8.69043 11.7701L8.5 10.7672L7.5 9.76717V7.82674C7.50121 6.5986 10.5348 5.88296 14.5 5.78084V2.76717C14.5 2.45924 14.6421 2.16859 14.8848 1.97908ZM8.5 13.7672C12.366 13.7672 15.5 15.9677 15.5 17.6246C15.4997 19.2812 12.3658 19.7672 8.5 19.7672C4.63421 19.7672 1.50033 19.2812 1.5 17.6246C1.5 15.9677 4.63401 13.7672 8.5 13.7672Z" fill="currentColor"/></g><defs><clipPath id="clip0_1005_11986"><rect width="24" height="24" fill="white" transform="translate(0.5 0.76709)"/></clipPath></defs></svg></span>
        </div>
        <div class="nav-item active">
            <span class="nav-icon"><svg width="25" height="25" viewBox="0 0 25 25" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10.9787 12.0459L13.3908 12.0557L15.7942 7.98438H24.3V10.7119L22.3029 11.8027L21.0842 16.6182C20.4898 18.7581 20.1931 19.8285 19.5227 20.584C19.145 21.0095 18.6871 21.3574 18.176 21.6074C17.2687 22.0511 16.1577 22.0508 13.9367 22.0508H10.6643C8.44311 22.0508 7.33236 22.0513 6.42502 21.6074C5.91397 21.3574 5.45699 21.0095 5.07932 20.584C4.40884 19.8285 4.11129 18.7583 3.51682 16.6182L2.29904 11.8027L0.300018 10.7119V7.98438H10.383L14.6115 1H17.6594L10.9787 12.0459Z" fill="currentColor"/></svg></span>
            <span class="nav-badge"></span>
        </div>
    </nav>

    <script src="./config/app-config.js"></script>
    <script src="./config/items-config.js"></script>
    <script>
        // Mock Data Store
        const SCHEMA_VERSION = 2;
        const appData = {
            user: {
                id: '12345',
                hasPlus: APP_CONFIG.userDefaults.hasPlus,
                payWithYandexPay: APP_CONFIG.userDefaults.payWithYandexPay,
                location: APP_CONFIG.userDefaults.location,
                deliverySpeed: APP_CONFIG.userDefaults.deliverySpeed
            },
            activeCartId: 'home',
            carts: {
                home: {
                    items: [
                        { refId: 'raspberry_artfruit', quantity: 2 }
                    ],
                    delivery: {
                        time: APP_CONFIG.userDefaults.deliverySpeed,
                        minForDiscount: 1151,
                        currentTotal: 510
                    },
                    packaging: {
                        cost: APP_CONFIG.packaging.fee,
                        returnable: false,
                        points: 12
                    }
                },
                big: {
                    items: [
                        { refId: 'snickers_ice_cream', quantity: 2 }
                    ],
                    delivery: {},
                    packaging: { cost: APP_CONFIG.packaging.fee }
                }
            },
            recommendations: [
                {id: 'snickers', name: 'Snickers', emoji: '🍫', promo: '×2'},
                {id: 'drink_generic', name: 'Напиток', emoji: '🥤'},
                {id: 'cookie_generic', name: 'Печенье', emoji: '🍪'}
            ],
            promos: [
                {
                    id: 'kinder50',
                    discount: 50,
                    product: 'Kinder Сюрприз с фиксиками',
                    active: true
                }
            ],
            meta: { version: SCHEMA_VERSION }
        };

        // Schema migration utilities
        function guessRefIdFromLegacyItem(legacy) {
            // Try match by explicit legacy id/name; fallback to known slug
            const catalog = (window.ITEMS_CONFIG && window.ITEMS_CONFIG.catalog) || {};
            // Match by name
            for (const key in catalog) {
                if (catalog[key].name === legacy.name) return key;
            }
            // Fallback legacy id mapping
            if (legacy.id === 1) return 'raspberry_artfruit';
            return null;
        }
    
            function migrateDataSchema(data) {
                const migrated = JSON.parse(JSON.stringify(data || {}));
                migrated.meta = migrated.meta || {};
                const currentVersion = Number(migrated.meta.version || 0);
                if (currentVersion >= SCHEMA_VERSION) {
                    if (!migrated.carts) { // Handle case where old structure exists despite version
                         migrated.carts = { home: migrated.cart || {}, big: { items:[] } };
                         migrated.activeCartId = migrated.activeCartId || 'home';
                         delete migrated.cart;
                    }
                    return migrated;
                }
    
                // If we are migrating from a pre-multi-cart version
                if (migrated.cart) {
                    migrated.carts = {
                        home: migrated.cart,
                        big: { items: [], delivery: {}, packaging: { cost: APP_CONFIG.packaging.fee } }
                    };
                    delete migrated.cart;
                }
                migrated.activeCartId = migrated.activeCartId || 'home';
                migrated.carts = migrated.carts || { home: {items:[]}, big: {items:[]} };
    
                // Ensure user defaults
                migrated.user = migrated.user || {};
                if (migrated.user.hasPlus == null) migrated.user.hasPlus = APP_CONFIG.userDefaults.hasPlus;
                if (migrated.user.payWithYandexPay == null) migrated.user.payWithYandexPay = APP_CONFIG.userDefaults.payWithYandexPay;
                if (!migrated.user.location) migrated.user.location = APP_CONFIG.userDefaults.location;
                if (!migrated.user.deliverySpeed) migrated.user.deliverySpeed = APP_CONFIG.userDefaults.deliverySpeed;
    
                // Update items in both carts if they exist
                for (const cartId in migrated.carts) {
                    const cart = migrated.carts[cartId] || { items: [] };
                    const items = Array.isArray(cart.items) ? cart.items : [];
                    cart.items = items.map(it => {
                        if (it && (it.refId || typeof it.refId === 'string')) {
                            return { refId: it.refId, quantity: Number(it.quantity) || 1 };
                        }
                        const refId = guessRefIdFromLegacyItem(it || {});
                        return { refId: refId || 'raspberry_artfruit', quantity: Number(it?.quantity) || 1 };
                    });
    
                    // Packaging defaults
                    cart.packaging = cart.packaging || {};
                    if (cart.packaging.cost == null) cart.packaging.cost = APP_CONFIG.packaging.fee;
                    if (cart.packaging.returnable == null) cart.packaging.returnable = false;
    
                    // Delivery defaults
                    cart.delivery = cart.delivery || {};
                    if (!cart.delivery.time) cart.delivery.time = APP_CONFIG.userDefaults.deliverySpeed;
                }
    
                migrated.meta.version = SCHEMA_VERSION;
                return migrated;
            }
    
            // Store/migrate data in sessionStorage for persistence
            (function seedOrMigrate(){
                sessionStorage.clear(); // Force a one-time reset
                let data;
                try {
                    data = JSON.parse(sessionStorage.getItem('appData'));
                } catch (e) {
                    data = null;
                }
                if (!data) {
                    data = appData;
                }
                const migrated = migrateDataSchema(data);
                sessionStorage.setItem('appData', JSON.stringify(migrated));
            })();

        function getActiveCart() {
            const data = JSON.parse(sessionStorage.getItem('appData'));
            if (data && data.carts && data.carts[data.activeCartId]) {
                return data.carts[data.activeCartId];
            }
            // Return a default empty cart structure to prevent errors
            return { items: [], delivery: {}, packaging: {} };
        }

        // Toggle switch for package return
        function toggleSwitch(element) {
            element.classList.toggle('active');
            
            // Update stored data
            const data = JSON.parse(sessionStorage.getItem('appData'));
            const cart = data.carts[data.activeCartId];
            cart.packaging.returnable = element.classList.contains('active');
            sessionStorage.setItem('appData', JSON.stringify(data));
        }

        // Resolve item data from catalog by refId
        function resolveItemByRef(refId) {
            return (window.ITEMS_CONFIG && window.ITEMS_CONFIG.catalog && window.ITEMS_CONFIG.catalog[refId]) || null;
        }

        // Render the (single) cart item row based on catalog
        function renderCartItems() {
            const cart = getActiveCart();
            const cartContainer = document.querySelector('.cart-items');
            cartContainer.innerHTML = ''; // Clear existing items

            if (!cart || !cart.items || cart.items.length === 0) {
                cartContainer.innerHTML = '<p style="text-align: center; color: var(--color-text-secondary);">Корзина пуста</p>';
                return;
            }

            cart.items.forEach(cartItem => {
                const itemDef = resolveItemByRef(cartItem.refId);
                if (!itemDef) return;

                const itemEl = document.createElement('div');
                itemEl.className = 'cart-item';

                const priceOldHTML = itemDef.oldPrice && itemDef.oldPrice > itemDef.price 
                    ? `<span class="price-old">${formatPrice(itemDef.oldPrice)}</span>` 
                    : '';
                
                const imageHTML = itemDef.image 
                    ? `<img src="${itemDef.image}" alt="${itemDef.name}" style="width: 100%; height: 100%; object-fit: cover; border-radius: var(--radius-sm);">`
                    : itemDef.emoji || '';
                
                const weightHTML = itemDef.weight ? `<span class="price-weight">· ${itemDef.weight}</span>` : '';
                const hasDiscount = itemDef.oldPrice && itemDef.oldPrice > itemDef.price;

                itemEl.innerHTML = `
                    <div class="item-image">${imageHTML}</div>
                    <div class="item-details">
                        <div class="item-name">${itemDef.name}</div>
                        <div class="item-price">
                            <span class="price-current ${hasDiscount ? 'has-discount' : ''}">${formatPrice(itemDef.price)}</span>
                            ${priceOldHTML}
                            ${weightHTML}
                        </div>
                    </div>
                    <div class="quantity-controls">
                        <button class="qty-btn" onclick="updateQuantity(event, '${cartItem.refId}', -1)">−</button>
                        <span class="qty-value">${cartItem.quantity}</span>
                        <button class="qty-btn" onclick="updateQuantity(event, '${cartItem.refId}', 1)">+</button>
                    </div>
                `;
                cartContainer.appendChild(itemEl);
            });
        }

        // Helpers: formatting and totals
        function formatPrice(value) {
            return `${value}${APP_CONFIG.currency}`;
        }

        function computeCartTotals(cart) {
            if (!cart) return { itemsFinalTotal: 0, itemsOriginalTotal: 0, totalQuantity: 0 };
            let itemsFinalTotal = 0;
            let itemsOriginalTotal = 0;
            let totalQuantity = 0;
            (cart.items || []).forEach(ci => {
                const def = resolveItemByRef(ci.refId);
                if (!def) return;
                const qty = Number(ci.quantity) || 0;
                totalQuantity += qty;
                const price = Number(def.price) || 0;
                const old = def.oldPrice != null ? Number(def.oldPrice) : price;
                itemsFinalTotal += price * qty;
                itemsOriginalTotal += old * qty;
            });
            return { itemsFinalTotal, itemsOriginalTotal, totalQuantity };
        }

        function computeTotalQuantityAllCarts(data) {
            if (!data || !data.carts) return 0;
            let totalQuantity = 0;
            for (const cartId in data.carts) {
                const cart = data.carts[cartId];
                if (cart && cart.items) {
                    cart.items.forEach(item => {
                        totalQuantity += Number(item.quantity) || 0;
                    });
                }
            }
            return totalQuantity;
        }

        function computeTotals(data) {
            const cart = data.carts[data.activeCartId];
            return computeCartTotals(cart);
        }

        // Determine if user uses Yandex Pay card
        function isYandexPayEnabled(data) {
            return Boolean(data?.user?.payWithYandexPay ?? data?.user?.hasPlus);
        }

        // Delivery fee schedule based on items total and payment method
        function getDeliveryFee(itemsTotal, withYandexPay) {
            const schedule = withYandexPay ? APP_CONFIG.delivery.tiers.yandexPay : APP_CONFIG.delivery.tiers.regular;
            let fee = 0;
            for (let i = schedule.length - 1; i >= 0; i--) {
                if (itemsTotal >= schedule[i].threshold) {
                    fee = schedule[i].fee;
                    break;
                }
            }
            return fee;
        }

        // Cart-size discount rate based on items total
        function getCartDiscountRate(itemsTotal) {
            for (const tier of APP_CONFIG.cartDiscount.tiers) {
                if (itemsTotal > tier.threshold) return tier.rate;
            }
            return 0.0;
        }

        // Next discount threshold and percent
        function getNextDiscountTarget(itemsTotal) {
            // Find next higher threshold from config (ascending compute)
            const thresholds = [...APP_CONFIG.cartDiscount.tiers]
                .map(t => ({ amount: t.threshold, percent: t.percent }))
                .sort((a, b) => a.amount - b.amount);
            for (const t of thresholds) {
                if (itemsTotal <= t.amount) return { nextAmount: t.amount, nextPercent: t.percent };
            }
            return { nextAmount: null, nextPercent: thresholds[thresholds.length - 1].percent };
        }

        function renderMilestones() {
            const data = JSON.parse(sessionStorage.getItem('appData'));
            const usesYandexPay = isYandexPayEnabled(data);
            const deliveryTiers = [...(usesYandexPay ? APP_CONFIG.delivery.tiers.yandexPay : APP_CONFIG.delivery.tiers.regular)].sort((a,b) => a.threshold - b.threshold);
            const discountTiers = APP_CONFIG.cartDiscount.tiers;
            const track = document.querySelector('.progress-bar-track');
            
            track.innerHTML = '<div class="progress-bar-fill"></div>';

            const hereMarker = document.createElement('div');
            hereMarker.className = 'milestone';
            hereMarker.id = 'here-marker';
            const hereLabel = document.createElement('div');
            hereLabel.className = 'milestone-label-top';
            hereLabel.textContent = 'Вы здесь';
            hereMarker.appendChild(hereLabel);
            track.appendChild(hereMarker);

            const allTiers = [
                ...deliveryTiers.map(t => ({ ...t, type: 'delivery' })),
                ...discountTiers.map(t => ({ ...t, type: 'discount' }))
            ];
            const maxThreshold = Math.max(...allTiers.map(t => t.threshold));
            
            allTiers.forEach(tier => {
                const milestoneEl = document.createElement('div');
                milestoneEl.className = 'milestone';
                milestoneEl.dataset.threshold = tier.threshold;
                
                let labelText = '';
                let iconHTML = '';

                if (tier.type === 'delivery') {
                    milestoneEl.dataset.fee = tier.fee;
                    labelText = `${tier.fee}₽`;
                } else { // discount
                    if (tier.threshold === 0) return;
                    milestoneEl.classList.add('discount');
                    milestoneEl.dataset.percent = tier.percent;
                    labelText = `${tier.percent}%`;
                    iconHTML = '<span class="discount-icon">%</span> ';
                }
                
                const positionPct = (tier.threshold / maxThreshold) * 100;
                milestoneEl.style.left = `${positionPct}%`;

                if (positionPct === 0) {
                    milestoneEl.classList.add('milestone-first');
                }
                if (positionPct === 100) {
                    milestoneEl.classList.add('milestone-last');
                }

                milestoneEl.innerHTML = `
                    <div class="milestone-label">${iconHTML}${labelText}</div>
                `;
                track.appendChild(milestoneEl);
            });
        }

        function updateDeliveryInfo() {
            const data = JSON.parse(sessionStorage.getItem('appData'));
            const { itemsFinalTotal } = computeTotals(data);
            const usesYandexPay = isYandexPayEnabled(data);

            const deliveryTiers = usesYandexPay ? APP_CONFIG.delivery.tiers.yandexPay : APP_CONFIG.delivery.tiers.regular;
            const deliveryFee = getDeliveryFee(itemsFinalTotal, usesYandexPay);
            const originalFee = getDeliveryFee(itemsFinalTotal, false);

            document.getElementById('delivery-cost').innerHTML = `Доставка <strong class="delivery-fee-value">${deliveryFee}₽</strong>`;
            const discountBadge = document.getElementById('delivery-discount');
            const originalCostEl = document.getElementById('delivery-original-cost');

            if (usesYandexPay && deliveryFee < originalFee) {
                const discountPct = Math.round((1 - deliveryFee / originalFee) * 100);
                discountBadge.textContent = `-${discountPct}%`;
                discountBadge.style.display = 'inline-block';
                originalCostEl.textContent = `/ без: ${originalFee}₽`;
            } else {
                discountBadge.style.display = 'none';
                originalCostEl.textContent = '';
            }

            const nextTier = deliveryTiers.find(tier => itemsFinalTotal < tier.threshold);
            const hintEl = document.getElementById('delivery-hint');
            if (nextTier) {
                const remaining = nextTier.threshold - itemsFinalTotal;
                hintEl.textContent = `Ещё ${remaining}₽, и будет ${nextTier.fee}₽`;
            } else {
                hintEl.textContent = deliveryFee === 0 ? 'Доставка бесплатная' : '';
            }

            const progressBarFill = document.querySelector('.progress-bar-fill');
            const allTiers = [
                ...deliveryTiers.map(t => ({ ...t, type: 'delivery' })),
                ...APP_CONFIG.cartDiscount.tiers.map(t => ({ ...t, type: 'discount' }))
            ];
            const maxThreshold = Math.max(...allTiers.map(t => t.threshold || 0));

            const hereMarker = document.getElementById('here-marker');
            if (hereMarker) {
                const herePosition = Math.min(100, (itemsFinalTotal / maxThreshold) * 100);
                hereMarker.style.left = `${herePosition}%`;
            }

            const progressPercentage = Math.min(100, (itemsFinalTotal / maxThreshold) * 100);
            progressBarFill.style.width = `${progressPercentage}%`;

            const milestones = document.querySelectorAll('.milestone');
            milestones.forEach(milestone => {
                const threshold = parseInt(milestone.dataset.threshold);
                if (isNaN(threshold)) return;

                const isComplete = itemsFinalTotal >= threshold;
                milestone.classList.toggle('complete', isComplete);

                if (milestone.classList.contains('discount')) {
                    // No special 'active' state for discounts, only 'complete'
                } else {
                    const fee = parseInt(milestone.dataset.fee);
                    const isActive = deliveryFee === fee;
                    milestone.classList.toggle('active', isActive);
                }
            });
        }

        function populatePromoBanner() {
            if (window.APP_CONFIG && APP_CONFIG.promoBanner) {
                const badgeEl = document.getElementById('promo-badge-text');
                const textEl = document.getElementById('promo-main-text');

                if (badgeEl) {
                    badgeEl.textContent = APP_CONFIG.promoBanner.badgeText;
                }
                if (textEl) {
                    textEl.innerHTML = APP_CONFIG.promoBanner.mainText;
                }
            }
        }

        function updateTabIcons() {
            const data = JSON.parse(sessionStorage.getItem('appData'));
            if (!data || !data.carts) return;

            document.querySelectorAll('.tab').forEach(tab => {
                const storeId = tab.dataset.store;
                const cart = data.carts[storeId];
                const iconContainer = tab.querySelector('.tab-icon');
                if (!iconContainer) return;

                const firstItem = cart && cart.items.length > 0 ? resolveItemByRef(cart.items[0].refId) : null;

                if (firstItem && firstItem.image) {
                    iconContainer.innerHTML = `<img src="${firstItem.image}" alt="${firstItem.name}">`;
                } else if (firstItem && firstItem.emoji) {
                    iconContainer.innerHTML = firstItem.emoji;
                } else {
                    iconContainer.innerHTML = storeId === 'home' ? '🏪' : '🏬';
                }
            });
        }

        function updateAllTabSubtitles() {
            const data = JSON.parse(sessionStorage.getItem('appData'));
            if (!data || !data.carts) return;

            for (const cartId in data.carts) {
                const cart = data.carts[cartId];
                const { itemsFinalTotal } = computeCartTotals(cart);
                const tab = document.querySelector(`.tab[data-store="${cartId}"]`);
                if (tab) {
                    const subtitleEl = tab.querySelector('.tab-subtitle');
                    if (subtitleEl) {
                        subtitleEl.textContent = formatPrice(itemsFinalTotal);
                    }
                }
            }
        }

        // Recalculate UI: totals, progress, badges
        function recalculateCart() {
            const data = JSON.parse(sessionStorage.getItem('appData'));
            if (!data || !data.carts) return;

            const { itemsFinalTotal, itemsOriginalTotal, totalQuantity } = computeTotals(data);

            // Delivery fee based on items total and payment method
            const usesYandexPay = isYandexPayEnabled(data);
            const deliveryFeeWithYP = getDeliveryFee(itemsFinalTotal, true);
            const deliveryFeeWithoutYP = getDeliveryFee(itemsFinalTotal, false);
            const deliveryFee = usesYandexPay ? deliveryFeeWithYP : deliveryFeeWithoutYP;

            // Update delivery progress towards next cart-size discount tier
            const target = getNextDiscountTarget(itemsFinalTotal);
            let remaining = 0;
            let progressPct = 100;
            if (target.nextAmount) {
                remaining = Math.max(0, target.nextAmount - itemsFinalTotal);
                progressPct = Math.min(100, (itemsFinalTotal / target.nextAmount) * 100);
            }

            const progressFill = document.querySelector('.progress-bar-fill');
            if (progressFill) {
                progressFill.style.width = `${progressPct}%`;
            }
            const hint = document.getElementById('delivery-hint');
            if (hint) {
                if (target.nextAmount && remaining > 0) {
                    hint.textContent = `Ещё ${remaining}${APP_CONFIG.currency}, и скидка ${target.nextPercent}%`;
                } else {
                    const applied = Math.round(getCartDiscountRate(itemsFinalTotal) * 100);
                    if (applied > 0) {
                        hint.textContent = `Скидка ${applied}% применена`;
                    } else {
                        hint.textContent = 'Добавьте товары для скидки';
                    }
                }
            }

            // Update delivery text line and small label
            const deliveryLine = document.getElementById('deliveryLine');
            if (deliveryLine) {
                deliveryLine.innerHTML = `Доставка ${deliveryFeeWithYP}${APP_CONFIG.currency} <span class="badge-green">-20%</span> / без: ${deliveryFeeWithoutYP}${APP_CONFIG.currency}`;
            }

            // Update goal labels (next discount tier info)
            const goalPercentEl = document.getElementById('goalPercentLabel');
            const goalAmountEl = document.getElementById('goalAmountLabel');
            if (goalPercentEl && goalAmountEl) {
                if (target.nextAmount) {
                    goalPercentEl.textContent = `🎯 ${target.nextPercent}%`;
                    goalAmountEl.textContent = formatPrice(target.nextAmount);
                } else {
                    const applied = Math.round(getCartDiscountRate(itemsFinalTotal) * 100);
                    goalPercentEl.textContent = `🎯 ${applied}%`;
                    goalAmountEl.textContent = '';
                }
            }

            // Update checkout totals (items only)
            const packagingFee = Number(data.carts[data.activeCartId].packaging?.cost) || 0;
            const originalTotal = itemsOriginalTotal + packagingFee + deliveryFee;
            const preDiscountFinalTotal = itemsFinalTotal + packagingFee + deliveryFee;
            const rate = getCartDiscountRate(itemsFinalTotal);
            const finalAfterDiscount = Math.round(preDiscountFinalTotal * (1 - rate));

            const priceFinalEl = document.querySelector('.checkout-price .price-final');
            const priceOriginalEl = document.querySelector('.checkout-price .price-original');
            if (priceFinalEl) priceFinalEl.textContent = formatPrice(finalAfterDiscount);
            if (priceOriginalEl) {
                if (originalTotal > finalAfterDiscount) {
                    priceOriginalEl.style.display = '';
                    priceOriginalEl.textContent = formatPrice(originalTotal);
                } else {
                    priceOriginalEl.style.display = 'none';
                }
            }

            // Update bottom nav cart badge
            const navBadge = document.querySelector('.bottom-nav .nav-badge');
            if (navBadge) {
                const totalQuantityAllCarts = computeTotalQuantityAllCarts(data);
                if (totalQuantityAllCarts > 0) {
                    navBadge.textContent = String(totalQuantityAllCarts);
                    navBadge.style.display = '';
                } else {
                    navBadge.style.display = 'none';
                }
            }

            // Update tab subtitles and icons
            updateAllTabSubtitles();
            updateTabIcons();

            // Persist currentTotal for delivery section
            const activeCart = data.carts[data.activeCartId];
            if (activeCart) {
                if (!activeCart.delivery) {
                    activeCart.delivery = {};
                }
                activeCart.delivery.currentTotal = itemsFinalTotal;
            }
            sessionStorage.setItem('appData', JSON.stringify(data));
        }

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                if (this.classList.contains('active')) return;

                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                // Update store type in data
                const storeType = this.dataset.store;
                const data = JSON.parse(sessionStorage.getItem('appData'));
                data.activeCartId = storeType;
                sessionStorage.setItem('appData', JSON.stringify(data));

                // Recalc to refresh tab subtitle
                renderCartItems();
                renderRecommendations(storeType);
                recalculateCart();
                renderMilestones();
                updateDeliveryInfo();
            });
        });

        // Prevent pull-to-refresh on iOS
        let lastY = 0;
        document.addEventListener('touchstart', function(e) {
            lastY = e.touches[0].clientY;
        }, {passive: false});

        document.addEventListener('touchmove', function(e) {
            const y = e.touches[0].clientY;
            const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
            
            if (scrollTop === 0 && y > lastY) {
                e.preventDefault();
            }
        }, {passive: false});

        // Prevent pinch-to-zoom on iOS
        document.addEventListener('touchmove', function (event) {
          if (event.scale !== 1) { event.preventDefault(); }
        }, { passive: false });

        // Initialize
        window.addEventListener('load', function() {
            // Load saved state
            const data = JSON.parse(sessionStorage.getItem('appData'));
            
            // Set the correct active tab on page load
            if (data && data.activeCartId) {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                const activeTab = document.querySelector(`.tab[data-store="${data.activeCartId}"]`);
                if (activeTab) {
                    activeTab.classList.add('active');
                }
            }
            
            populatePromoBanner();

            const activeCart = getActiveCart();

            if (activeCart.packaging && activeCart.packaging.returnable) {
                document.getElementById('packageToggle').classList.add('active');
            }
            
            // Sync delivery ETA from user state
            const timeEl = document.querySelector('.checkout-time');
            if (timeEl && data?.user?.deliverySpeed) {
                timeEl.textContent = data.user.deliverySpeed;
            }

            // Render items UI from catalog
            renderCartItems();
            renderRecommendations(data ? data.activeCartId : 'home');

            // Initial totals/progress
            recalculateCart();
            renderMilestones();
            updateDeliveryInfo();
        });

        // Render recommendations
        function renderRecommendations(activeCartId) {
            const recKey = `recommendationItems_${activeCartId}`;
            const recs = (window.APP_CONFIG && window.APP_CONFIG[recKey]) || [];
            const grid = document.querySelector('.recommendations-grid');
            if (!grid) return;
            grid.innerHTML = '';

            const data = JSON.parse(sessionStorage.getItem('appData'));
            const cart = (data && data.carts && data.carts[activeCartId]) || { items: [] };

            recs.forEach(itemId => {
                const itemDef = resolveItemByRef(itemId);
                if (!itemDef) return;

                const card = document.createElement('div');
                card.className = 'recommendation-card';

                const priceOldHTML = itemDef.oldPrice && itemDef.oldPrice > itemDef.price 
                    ? `<span class="price-old">${formatPrice(itemDef.oldPrice)}</span>` 
                    : '';
                
                const hasDiscount = itemDef.oldPrice && itemDef.oldPrice > itemDef.price;
                const discount = hasDiscount ? Math.round((1 - (itemDef.price / itemDef.oldPrice)) * 100) : 0;
                
                const discountBadgeHTML = hasDiscount 
                    ? `<div class="rec-discount-badge">-${discount}%</div>`
                    : '';
                
                const imageHTML = itemDef.image
                    ? `<img src="${itemDef.image}" alt="${itemDef.name}" class="rec-image">`
                    : `<div class="rec-image" style="font-size: 32px;">${itemDef.emoji || ''}</div>`;

                const itemInCart = cart.items.find(it => it.refId === itemDef.id);
                const quantity = itemInCart ? itemInCart.quantity : 0;

                let controlsHTML = '';
                if (quantity > 0) {
                    controlsHTML = `
                        <div class="rec-quantity-controls">
                            <button class="qty-btn" onclick="updateQuantity(event, '${itemDef.id}', -1)">−</button>
                            <span class="qty-value">${quantity}</span>
                            <button class="qty-btn" onclick="updateQuantity(event, '${itemDef.id}', 1)">+</button>
                        </div>
                    `;
                } else {
                    controlsHTML = `<button class="rec-add-btn" onclick="updateQuantity(event, '${itemDef.id}', 1)">+</button>`;
                }

                card.innerHTML = `
                    <div class="rec-image-container">
                        ${imageHTML}
                        ${discountBadgeHTML}
                        ${controlsHTML}
                    </div>
                    <div class="rec-details">
                        <div class="rec-price">
                            <span class="price-current ${hasDiscount ? 'has-discount' : ''}">${formatPrice(itemDef.price)}</span>
                            ${priceOldHTML}
                        </div>
                        <div class="rec-name">${itemDef.name} <span class="rec-item-weight">${itemDef.weight}</span></div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // Quantity controls
        function updateQuantity(event, refId, change) {
            const isFromRecommendations = event.target.closest('.recommendations');
            const scrollY = isFromRecommendations ? window.scrollY : null;

            const data = JSON.parse(sessionStorage.getItem('appData'));
            const cart = data.carts[data.activeCartId];
            const item = cart.items.find(it => it.refId === refId);

            if (item) {
                item.quantity += change;
                if (item.quantity <= 0) {
                    // Remove item if quantity is 0 or less
                    cart.items = cart.items.filter(it => it.refId !== refId);
                }
            } else if (change > 0) {
                cart.items.push({ refId, quantity: change });
            }
            
            sessionStorage.setItem('appData', JSON.stringify(data));
            
            renderCartItems();
            renderRecommendations(data.activeCartId);
            recalculateCart();
            updateDeliveryInfo();

            if (scrollY !== null) {
                window.scrollTo({ top: scrollY, behavior: 'instant' });
            }
        }
    </script>
</body>
</html>